name: Build OpenWrt Network Switcher Plugin

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PACKAGE_NAME: network-switcher

jobs:
  build:
    runs-on: ubuntu-20.04  # 使用更稳定的 20.04
    strategy:
      matrix:
        target: [x86-64]
        sdk_url: [https://downloads.immortalwrt.org/releases/21.02.5/targets/x86/64/immortalwrt-sdk-21.02.5-x86-64_gcc-8.4.0_musl.Linux-x86_64.tar.xz]

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip python3

    - name: Setup SDK
      run: |
        mkdir sdk
        cd sdk
        wget -q ${{ matrix.sdk_url }}
        tar -xf *.tar.xz --strip-components=1
        cd ..

    - name: Prepare package
      run: |
        mkdir -p sdk/package/${{ env.PACKAGE_NAME }}
        cp Makefile sdk/package/${{ env.PACKAGE_NAME }}/
        cp -r files sdk/package/${{ env.PACKAGE_NAME }}/

    - name: Build
      run: |
        cd sdk
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "CONFIG_PACKAGE_${{ env.PACKAGE_NAME }}=m" > .config
        make defconfig
        make package/${{ env.PACKAGE_NAME }}/compile V=s

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}
        path: sdk/bin/packages/*/base/*.ipk
